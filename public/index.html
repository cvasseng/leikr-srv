<!DOCTYPE html>
<html>
	<head>
		<title>Leikr</title>

		<meta charset="UTF-8" />

		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

		<script src="/socket.io/socket.io.js"></script>


		<link href='http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
	

		<link href='http://fonts.googleapis.com/css?family=Monda' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="css/style.css">

    <style>
    #container {
      font-family: 'Roboto Condensed', sans-serif;
    }
    </style>

	</head>

<body>


	<h2>Leikr Test</h2>
	<div id="container" style="position:fixed;left:0px;top:0px;width:100%;height:100%"></div>

</body>

		<script src="js/leikr.js"></script>
		<script src="js/lei.sprite.js"></script>
		<script src="js/lei.surface.js"></script>
		<script src="js/lei.world.js"></script>
		<script src="js/lei.tile.js"></script>

<script>
		
//	var surface = new lei.Surface();
////	surface.attachTo(document.getElementById('container'));
//	surface.resize(1000, 600);
//  surface.blitText({str:'Hello world!'});
$(document).ready(function () {

	var keys = [];

  lei.world.init(document.getElementById('container'));

  var socket = io.connect();

  $(window).resize(function() {
    lei.world.resize();
  });

  document.body.onkeyup = function (e) {
  	
  	keys[e.keyCode] = false;

  	if (keys[65] !== true && keys[68] !== true) {
  		socket.emit('move', {moving:false, direction:'horizontal'});
      lei.world.player().applyVelocity(0, lei.world.player().velocity.y);
      console.log('Removing velocity from player ' + JSON.stringify(lei.world.player().pos));
  	}

    if (keys[83] !== true && keys[87] !== true) {
      socket.emit('move', {moving:false, direction:'vertical'});
      lei.world.player().applyVelocity(lei.world.player().velocity.x, 0);
      console.log('Removing velocity from player ' + JSON.stringify(lei.world.player().pos));
    }
  };

  document.body.onkeydown = function (e) {
  	var key = e.keyCode, direction = false;
  	
  	if (key == 65 && keys[key] !== true) {
			direction = 'left';
      lei.world.player().applyVelocity(-1, lei.world.player().velocity.y);
      console.log('Applying velocity to player');
		}
		if (key == 68 && keys[key] !== true) {
			direction = 'right';
      lei.world.player().applyVelocity(1,  lei.world.player().velocity.y);
      console.log('Applying velocity to player');
		}
		if (key == 32 && keys[key] !== true) {
			socket.emit('jump');
		}

    if (key == 87 && keys[key] !== true) {
      direction = 'up';
      lei.world.player().applyVelocity(lei.world.player().velocity.x, -1);
    }

    if (key == 83 && keys[key] !== true) {
      direction = 'down';
      lei.world.player().applyVelocity(lei.world.player().velocity.x, 1);
    }

  //		console.log(key + ' ' + keys[key]);

		keys[key] = true;

		if (direction) {
			socket.emit('move', {
				moving: true,
				direction: direction
			});
		} else {

    }
  };

  socket.on('disconnect', function () {
    lei.world.flush();
  });

  socket.on('connect', function () {
  	lei.world.clear();
  	lei.world.flush();
  	socket.emit('logon');
  });

  socket.on('tile', function (data) {
  	lei.world.setTile(data.tx, data.ty, data.tile);
  });

  socket.on('chunk', function (chunk) {
  	lei.world.applyChunk(chunk);
  }); 

  socket.on('player', function (data) {
  	//Data contains a full player package.
    console.log('Got info on self');
  	lei.world.setPlayerData(data);
  });

  socket.on('actor_update', function (data) {

  	lei.world.updateActor(data);
  });

  socket.on('player_correction', function (data) {
    lei.world.player().move(data.pos.x, data.pos.y);
  });

  //Spawn something
  socket.on('spawn', function (data) {
  	console.log('Spawning actor: ' + JSON.stringify(data));
  	lei.world.spawn(data);
  });

  //Despawn something
  socket.on('despawn', function (id) {
  	console.log('Despawning actor: ' + id);
  	lei.world.despawn(id);
  });

});
</script>

</html>
